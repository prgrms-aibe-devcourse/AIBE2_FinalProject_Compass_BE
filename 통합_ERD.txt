# ğŸŒ Compass ì—¬í–‰ í”Œë«í¼ - í†µí•© ERD ë° ë„ë©”ì¸ë³„ Core API

## ğŸ“‹ ë„ë©”ì¸ êµ¬ì¡° ë° ë‹´ë‹¹ì
```
1. AI Client Domain (ê¹€ë¯¼ì œ) - AI ì±„íŒ… ì¸í„°í˜ì´ìŠ¤, ëŒ€í™” ê´€ë¦¬
2. User Management Domain (ê¹€í˜„ìŠ¹) - ì‚¬ìš©ì ê´€ë¦¬, ì¸ì¦, í”„ë¡œí•„
3. Recommendation Domain (ê¹€í˜„ìŠ¹) - ì¶”ì²œ, íë ˆì´ì…˜, íŠ¸ë Œë“œ
4. Trip Planning Domain (ì´ì„ì¬) - ì—¬í–‰ ê³„íš ìƒì„±, ì¼ì •, ì¥ì†Œ, ë‚ ì”¨, ì˜ˆì•½, AI ì—¬í–‰ ìƒì„±
5. Sharing Domain (ë‚¨ì •í˜„) - ê³µìœ , í˜‘ì—…, ë§í¬ ê´€ë¦¬
6. Payment & Billing Domain (ë‚¨ì •í˜„) - ê²°ì œ, í¬ë ˆë”§ ê´€ë¦¬
7. Review System Domain (ì¡°ë¯¼ê·€) - ë¦¬ë·°, í‰ì , í”¼ë“œë°±, ë§¤ì¹­
8. Media Management Domain (ì¡°ë¯¼ê·€) - ë¯¸ë””ì–´, íŒŒì¼ ê´€ë¦¬, í”¼ë“œ
```

---

# ğŸ—ï¸ ë„ë©”ì¸ë³„ ì—”í‹°í‹° ë° Core API

## 1. ğŸ’¬ AI Client Domain (ê¹€ë¯¼ì œ)

### ğŸ“Š Entities
```sql
-- ì±„íŒ… ìŠ¤ë ˆë“œ
ChatThread {
    thread_id: UUID (PK)
    user_id: UUID (FK â†’ User)
    title: VARCHAR(255)
    mode_id: INT (FK â†’ ChatMode)
    status: ENUM('active', 'archived', 'deleted')
    last_message_at: TIMESTAMP
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}

-- ë©”ì‹œì§€
Message {
    message_id: UUID (PK)
    thread_id: UUID (FK â†’ ChatThread)
    sender_type: ENUM('user', 'ai')
    content: TEXT
    image_url: VARCHAR(500)
    location_lat: DECIMAL(10,8)
    location_lng: DECIMAL(11,8)
    tokens_used: INT
    parent_message_id: UUID (FK â†’ Message)
    created_at: TIMESTAMP
}

-- ì±„íŒ… ëª¨ë“œ
ChatMode {
    mode_id: INT (PK)
    name: VARCHAR(50)
    description: TEXT
    context_prompt: TEXT
    is_active: BOOLEAN
    created_at: TIMESTAMP
}

-- AI ì‘ë‹µ ìºì‹œ
AIResponse {
    response_id: UUID (PK)
    question_pattern: VARCHAR(500) (INDEX)
    response_content: TEXT
    ttl_expires_at: TIMESTAMP
    hit_count: INT DEFAULT 0
    created_at: TIMESTAMP
}

-- API ì‚¬ìš©ëŸ‰ ë¡œê·¸
APIUsageLog {
    log_id: UUID (PK)
    user_id: UUID (FK â†’ User)
    thread_id: UUID (FK â†’ ChatThread)
    tokens_used: INT
    api_cost: DECIMAL(10,4)
    api_endpoint: VARCHAR(255)
    created_at: TIMESTAMP
}

-- ì±„íŒ…-ì—¬í–‰ ì—°ê²°
ChatTripLink {
    link_id: UUID (PK)
    thread_id: UUID (FK â†’ ChatThread)
    trip_id: UUID (FK â†’ Trip Domain)
    created_at: TIMESTAMP
}
```

### ğŸ”µ External APIs (ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
```yaml
Chat Management:
  GET /api/chat/threads: "ì±„íŒ… ëª©ë¡ ì¡°íšŒ"
  POST /api/chat/threads: "ìƒˆ ì±„íŒ… ìƒì„±"
  GET /api/chat/threads/{threadId}: "ì±„íŒ… ìƒì„¸ ì¡°íšŒ"
  DELETE /api/chat/threads/{threadId}: "ì±„íŒ… ì‚­ì œ"
  PUT /api/chat/threads/{threadId}/mode: "ì±„íŒ… ëª¨ë“œ ë³€ê²½"
  
Messages:
  GET /api/chat/threads/{threadId}/messages: "ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ"
  POST /api/chat/threads/{threadId}/messages: "ë©”ì‹œì§€ ì „ì†¡"
  POST /api/chat/threads/{threadId}/messages/image: "ì´ë¯¸ì§€ ì²¨ë¶€ ë©”ì‹œì§€"
  POST /api/chat/threads/{threadId}/messages/{messageId}/regenerate: "AI ì‘ë‹µ ì¬ìƒì„±"
  
AI Chat Context:
  GET /api/chat/threads/{threadId}/context: "ì±„íŒ… ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ"
  POST /api/chat/threads/{threadId}/trip-request: "ì—¬í–‰ ìƒì„± ìš”ì²­ ê¸°ë¡"
  
Usage & Statistics:
  GET /api/chat/usage: "í¬ë ˆë”§ ì‚¬ìš©ëŸ‰ ì¡°íšŒ"
  GET /api/chat/api-usage: "API ì‚¬ìš© í†µê³„"
```

### ğŸ”´ Internal APIs (ë„ë©”ì¸ ë‚´ë¶€ìš©)
```yaml
Internal:
  POST /api/internal/chat/cache-response: "AI ì‘ë‹µ ìºì‹±"
  GET /api/internal/chat/cache/{pattern}: "ìºì‹œ ì¡°íšŒ"
  POST /api/internal/chat/log-usage: "ì‚¬ìš©ëŸ‰ ë¡œê¹…"
```

---

## 2. ğŸ‘¤ User Management Domain (ê¹€í˜„ìŠ¹)

### ğŸ“Š Entities
```sql
-- ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´
User {
    id: UUID (PK)
    email: VARCHAR(255) (UNIQUE)
    password_hash: VARCHAR(255)
    nickname: VARCHAR(100) (UNIQUE)
    profile_image_url: VARCHAR(500)
    bio: TEXT
    preferred_region: VARCHAR(100)
    provider: ENUM('LOCAL', 'GOOGLE', 'KAKAO')
    role: ENUM('USER', 'ADMIN')
    status: ENUM('ACTIVE', 'BLOCKED', 'WITHDRAWN')
    is_2fa_enabled: BOOLEAN
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}

-- í”„ë¡œí•„
Profile {
    profile_id: UUID (PK)
    user_id: UUID (FK â†’ User, UNIQUE)
    travel_style: TEXT
    preferences: TEXT
    budget_level: VARCHAR(50)
    updated_at: TIMESTAMP
}

-- ë¡œê·¸ì¸ ê¸°ë¡
LoginHistory {
    id: UUID (PK)
    user_id: UUID (FK â†’ User)
    ip_address: VARCHAR(50)
    device_info: TEXT
    login_at: TIMESTAMP
}

-- ì‚¬ìš©ì í™œë™ ì¶”ì 
UserActivity {
    id: BIGSERIAL (PK)
    user_id: UUID (FK â†’ User)
    activity_type: VARCHAR(50)
    target_id: VARCHAR(255)
    ab_test_group: VARCHAR(50)
    created_at: TIMESTAMP
}

-- ê´€ë¦¬ì
AdminUser {
    id: UUID (PK)
    username: VARCHAR(100) (UNIQUE)
    password: VARCHAR(255)
    email: VARCHAR(255) (UNIQUE)
    role: ENUM('SUPER_ADMIN', 'ADMIN', 'MODERATOR')
    created_at: TIMESTAMP
    last_login_at: TIMESTAMP
}

-- ê´€ë¦¬ ëŒ€ìƒ ì‚¬ìš©ì
ManagedUser {
    id: UUID (PK)
    user_id: UUID (FK â†’ User)
    action: ENUM('BLOCK', 'UNBLOCK', 'WARNING')
    reason: TEXT
    admin_id: UUID (FK â†’ AdminUser)
    created_at: TIMESTAMP
    expires_at: TIMESTAMP
}
```

### ğŸ”µ External APIs
```yaml
Authentication:
  POST /api/auth/login: "ë¡œê·¸ì¸"
  POST /api/auth/logout: "ë¡œê·¸ì•„ì›ƒ"
  POST /api/auth/refresh: "í† í° ê°±ì‹ "
  GET /api/auth/social/{provider}: "ì†Œì…œ ë¡œê·¸ì¸"
  
User Profile:
  GET /api/users/{userId}: "ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ"
  GET /api/users/me: "í˜„ì¬ ì‚¬ìš©ì ì •ë³´"
  PUT /api/users/me: "í”„ë¡œí•„ ìˆ˜ì •"
  POST /api/users/signup: "íšŒì›ê°€ì…"
  DELETE /api/users/me: "íšŒì› íƒˆí‡´"
  POST /api/users/password/reset-request: "ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­"
  
Admin:
  GET /api/admin/dashboard: "ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ"
  GET /api/admin/users: "ì‚¬ìš©ì ëª©ë¡"
  PUT /api/admin/users/{userId}/role: "ì—­í•  ë³€ê²½"
  PUT /api/admin/users/{userId}/status: "ìƒíƒœ ë³€ê²½"
  PUT /api/admin/content/{contentType}/{contentId}/status: "ì½˜í…ì¸  ìŠ¹ì¸/ë°˜ë ¤"
```

### ğŸ”´ Internal APIs
```yaml
Internal:
  POST /api/internal/users/activity: "í™œë™ ë¡œê·¸ ê¸°ë¡"
  GET /api/internal/users/{userId}/permissions: "ê¶Œí•œ ì¡°íšŒ"
  PUT /api/internal/users/{userId}/trust-score: "ì‹ ë¢°ë„ ì ìˆ˜ ì—…ë°ì´íŠ¸"
```

---

## 3. ğŸ¯ Recommendation Domain (ê¹€í˜„ìŠ¹)

### ğŸ“Š Entities
```sql
-- íë ˆì´ì…˜ íŒ¨í‚¤ì§€
CurationPackage {
    id: UUID (PK)
    created_by: UUID (FK â†’ User, ê´€ë¦¬ì)
    title: VARCHAR(255)
    description: TEXT
    theme: VARCHAR(100)
    created_at: TIMESTAMP
}

-- íë ˆì´ì…˜ ì•„ì´í…œ
CurationPackageItem {
    id: UUID (PK)
    package_id: UUID (FK â†’ CurationPackage)
    place_id: UUID (FK â†’ Place)
    visit_order: INTEGER
}

-- ì¶”ì²œ ì´ë ¥
RecommendationHistory {
    id: UUID (PK)
    user_id: UUID (FK â†’ User)
    recommendation_type: VARCHAR(50)
    recommended_items: JSON
    clicked_items: JSON
    created_at: TIMESTAMP
}

-- íŠ¸ë Œë“œ ë°ì´í„°
TrendData {
    id: UUID (PK)
    trend_type: VARCHAR(50)
    location: VARCHAR(100)
    season: VARCHAR(20)
    data: JSON
    calculated_at: TIMESTAMP
}
```

### ğŸ”µ External APIs
```yaml
Recommendations:
  GET /api/recommendations/personalized: "ê°œì¸í™” ì¶”ì²œ"
  GET /api/recommendations/similar-users: "ìœ ì‚¬ ì‚¬ìš©ì ê¸°ë°˜ ì¶”ì²œ"
  GET /api/recommendations/popular: "ì¸ê¸° ì¶”ì²œ"
  
Curations:
  GET /api/curations: "íë ˆì´ì…˜ ëª©ë¡"
  GET /api/curations/{packageId}: "íë ˆì´ì…˜ ìƒì„¸"
  POST /api/curations: "íë ˆì´ì…˜ ìƒì„± (ê´€ë¦¬ì)"
  
Trends:
  GET /api/trends: "íŠ¸ë Œë“œ ë¶„ì„ ì¡°íšŒ"
  GET /api/trends/seasonal: "ì‹œì¦Œë³„ íŠ¸ë Œë“œ"
  GET /api/trends/regions: "ì§€ì—­ë³„ íŠ¸ë Œë“œ"
```

### ğŸ”´ Internal APIs
```yaml
Internal:
  POST /api/internal/recommendations/log: "ì¶”ì²œ ë¡œê·¸ ê¸°ë¡"
  POST /api/internal/trends/calculate: "íŠ¸ë Œë“œ ê³„ì‚°"
  GET /api/internal/recommendations/ab-test: "A/B í…ŒìŠ¤íŠ¸ ê·¸ë£¹ ì¡°íšŒ"
```

---

## 4. âœˆï¸ Trip Planning Domain (ì´ì„ì¬)

### ğŸ“Š Entities
```sql
-- ì—¬í–‰ ê³„íš
Trip {
    id: UUID (PK)
    owner_id: UUID (FK â†’ User)
    title: VARCHAR(255)
    description: TEXT
    destination: VARCHAR(255)
    start_date: DATE
    end_date: DATE
    status: ENUM('PLANNING', 'ACTIVE', 'COMPLETED', 'CANCELLED')
    budget: JSON
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}

-- ì—¬í–‰ ì°¸ì—¬ì
TripParticipant {
    id: UUID (PK)
    trip_id: UUID (FK â†’ Trip)
    user_id: UUID (FK â†’ User)
    role: ENUM('OWNER', 'EDITOR', 'VIEWER')
    invited_at: TIMESTAMP
    UNIQUE(trip_id, user_id)
}

-- ì¼ì • ì•„ì´í…œ
ScheduleItem {
    id: UUID (PK)
    trip_id: UUID (FK â†’ Trip)
    date: DATE
    start_time: TIME
    end_time: TIME
    title: VARCHAR(200)
    memo: TEXT
    place_id: UUID (FK â†’ Place)
    cost_minor: INT
    sort_order: INT
    updated_at: TIMESTAMP
}

-- ì²´í¬ë¦¬ìŠ¤íŠ¸
ChecklistItem {
    id: UUID (PK)
    trip_id: UUID (FK â†’ Trip)
    text: TEXT
    checked: BOOLEAN
    sort_order: INT
    updated_at: TIMESTAMP
}

-- ì¥ì†Œ ì •ë³´ (ìºì‹œ)
Place {
    id: UUID (PK)
    source: VARCHAR(50) -- google, kakao
    external_id: VARCHAR(255)
    name: VARCHAR(255)
    location: JSON -- {lat, lng, address}
    detail: JSON -- {openingHours, phone}
    cached_at: TIMESTAMP
    UNIQUE(source, external_id)
}

-- ì˜ˆì•½ ì •ë³´
Reservation {
    id: UUID (PK)
    trip_id: UUID (FK â†’ Trip)
    type: VARCHAR(50) -- hotel, flight, tour
    vendor: VARCHAR(100)
    ref_code: VARCHAR(100)
    start_at: TIMESTAMP
    end_at: TIMESTAMP
    amount_minor: INT
    currency: VARCHAR(3)
    status: ENUM('PENDING', 'CONFIRMED', 'CANCELLED')
    notes: TEXT
    updated_at: TIMESTAMP
}

-- ë‚ ì”¨ êµ¬ë…
WeatherSubscription {
    id: UUID (PK)
    user_id: UUID (FK â†’ User)
    trip_id: UUID (FK â†’ Trip)
    notify_time_local: TIME
    thresholds: JSON
    tz: VARCHAR(50)
    active: BOOLEAN
    UNIQUE(user_id, trip_id)
}

-- AI ìƒì„± ì—¬í–‰ ê³„íš (Trip Planning Domain)
AIGeneratedPlan {
    plan_id: UUID (PK)
    trip_id: UUID (FK â†’ Trip)
    chat_thread_id: UUID -- AI Clientì˜ thread_id ì°¸ì¡°
    ai_context: JSON -- AIê°€ ìƒì„±í•œ ì›ë³¸ ë°ì´í„°
    status: ENUM('draft', 'confirmed', 'modified')
    created_at: TIMESTAMP
}
```

### ğŸ”µ External APIs
```yaml
Trip Management:
  GET /api/trips: "ì—¬í–‰ ëª©ë¡"
  POST /api/trips: "ì—¬í–‰ ìƒì„±"
  GET /api/trips/{tripId}: "ì—¬í–‰ ìƒì„¸"
  PATCH /api/trips/{tripId}: "ì—¬í–‰ ìˆ˜ì •"
  DELETE /api/trips/{tripId}: "ì—¬í–‰ ì‚­ì œ"
  
AI Trip Generation:
  POST /api/trips/generate-from-chat: "AI ì±„íŒ… ê¸°ë°˜ ì—¬í–‰ ê³„íš ìƒì„±"
  GET /api/trips/ai-suggestions: "AI ì—¬í–‰ ì œì•ˆ ì¡°íšŒ"
  POST /api/trips/confirm-ai-plan: "AI ìƒì„± ê³„íš í™•ì •"
  
Participants:
  POST /api/trips/{tripId}/participants: "ì°¸ì—¬ì ì´ˆëŒ€"
  DELETE /api/trips/{tripId}/participants/{userId}: "ì°¸ì—¬ì ì œê±°"
  
Schedule:
  GET /api/trips/{tripId}/schedules: "ì¼ì • ì¡°íšŒ"
  POST /api/trips/{tripId}/schedules: "ì¼ì • ì¶”ê°€"
  PATCH /api/trips/{tripId}/schedules/{scheduleId}: "ì¼ì • ìˆ˜ì •"
  DELETE /api/trips/{tripId}/schedules/{scheduleId}: "ì¼ì • ì‚­ì œ"
  POST /api/trips/{tripId}/schedules/{scheduleId}/place: "ì¥ì†Œ ì—°ê²°"
  
Checklist:
  GET /api/trips/{tripId}/checklist: "ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ"
  POST /api/trips/{tripId}/checklist: "ì•„ì´í…œ ì¶”ê°€"
  PATCH /api/trips/{tripId}/checklist/{itemId}: "ì•„ì´í…œ ìˆ˜ì •"
  
Places:
  GET /api/places/search: "ì¥ì†Œ ê²€ìƒ‰"
  GET /api/places/{placeId}: "ì¥ì†Œ ìƒì„¸"
  GET /api/places/nearby: "ì£¼ë³€ ì¥ì†Œ"
  
Routes:
  GET /api/routes: "ê²½ë¡œ ê³„ì‚°"
  POST /api/routes/multi-point: "ë‹¤ì¤‘ ê²½ìœ ì§€ ê²½ë¡œ"
  
Reservations:
  GET /api/trips/{tripId}/reservations: "ì˜ˆì•½ ëª©ë¡"
  POST /api/trips/{tripId}/reservations: "ì˜ˆì•½ ì¶”ê°€"
  PATCH /api/trips/{tripId}/reservations/{reservationId}: "ì˜ˆì•½ ìˆ˜ì •"
  POST /api/reservations/email/parse: "ì´ë©”ì¼ ì˜ˆì•½ íŒŒì‹±"
  
Weather:
  GET /api/weather/current: "í˜„ì¬ ë‚ ì”¨"
  GET /api/weather/forecast: "ë‚ ì”¨ ì˜ˆë³´"
  GET /api/trips/{tripId}/weather/summary: "ì¼ì •ë³„ ë‚ ì”¨"
  POST /api/trips/{tripId}/weather/subscription: "ë‚ ì”¨ ì•Œë¦¼ êµ¬ë…"
```

### ğŸ”´ Internal APIs
```yaml
Internal:
  POST /api/internal/places/cache: "ì¥ì†Œ ìºì‹±"
  POST /api/internal/weather/cache: "ë‚ ì”¨ ìºì‹±"
  GET /api/internal/trips/{tripId}/validate-dates: "ë‚ ì§œ ê²€ì¦"
  POST /api/internal/reservations/validate: "ì˜ˆì•½ ê²€ì¦"
  POST /api/internal/trips/process-ai-context: "AI ì»¨í…ìŠ¤íŠ¸ ì²˜ë¦¬"
  GET /api/internal/trips/chat/{threadId}: "ì±„íŒ… ìŠ¤ë ˆë“œ ì—°ê´€ ì—¬í–‰ ì¡°íšŒ"
```

---

## 5. ğŸ”— Sharing Domain (ë‚¨ì •í˜„)

### ğŸ“Š Entities
```sql
-- ê³µìœ  ë§í¬
ShareLink {
    link_id: UUID (PK)
    trip_id: UUID (FK â†’ Trip)
    share_token: VARCHAR(255) (UNIQUE)
    is_active: BOOLEAN DEFAULT true
    expires_at: TIMESTAMP
    created_at: TIMESTAMP
}

-- ê³µìœ  ê¶Œí•œ
SharePermission {
    id: UUID (PK)
    share_link_id: UUID (FK â†’ ShareLink)
    permission_type: ENUM('VIEW', 'EDIT', 'COMMENT')
    created_at: TIMESTAMP
}

-- ê³µìœ  ì ‘ì† ê¸°ë¡
ShareAccessLog {
    id: UUID (PK)
    share_link_id: UUID (FK â†’ ShareLink)
    accessed_by_user_id: UUID (FK â†’ User, nullable)
    ip_address: VARCHAR(50)
    accessed_at: TIMESTAMP
}
```

### ğŸ”µ External APIs
```yaml
Sharing:
  POST /api/share/trips/{tripId}: "ê³µìœ  ë§í¬ ìƒì„±"
  GET /api/share/{token}: "ê³µìœ ëœ ì—¬í–‰ ì¡°íšŒ"
  DELETE /api/share/{linkId}: "ê³µìœ  ë§í¬ ì‚­ì œ"
  PUT /api/share/{linkId}/permissions: "ê¶Œí•œ ìˆ˜ì •"
  GET /api/share/{linkId}/access-log: "ì ‘ì† ê¸°ë¡ ì¡°íšŒ"
```

### ğŸ”´ Internal APIs
```yaml
Internal:
  POST /api/internal/share/validate-token: "í† í° ìœ íš¨ì„± ê²€ì¦"
  POST /api/internal/share/log-access: "ì ‘ì† ë¡œê·¸ ê¸°ë¡"
```

---

## 6. ğŸ’³ Payment & Billing Domain (ë‚¨ì •í˜„)

### ğŸ“Š Entities
```sql
-- í¬ë ˆë”§ ìƒí’ˆ
CreditProduct {
    product_id: UUID (PK)
    product_name: VARCHAR(255)
    price: DECIMAL(10,2)
    credit_amount: INT
    is_active: BOOLEAN
}

-- ê²°ì œ ë‚´ì—­
Payment {
    payment_id: UUID (PK)
    user_id: UUID (FK â†’ User)
    product_id: UUID (FK â†’ CreditProduct)
    amount: DECIMAL(10,2)
    status: VARCHAR(50)
    kakaopay_tid: VARCHAR(255) (UNIQUE)
    created_at: TIMESTAMP
}

-- í¬ë ˆë”§ ê±°ë˜
CreditTransaction {
    transaction_id: UUID (PK)
    user_id: UUID (FK â†’ User)
    transaction_type: VARCHAR(50)
    amount: INT
    description: VARCHAR(500)
    balance_after: INT
    created_at: TIMESTAMP
}

-- ì‚¬ìš©ì í¬ë ˆë”§ ì”ì•¡
UserCreditBalance {
    user_id: UUID (PK, FK â†’ User)
    balance: INT DEFAULT 0
    updated_at: TIMESTAMP
}
```

### ğŸ”µ External APIs
```yaml
Payment:
  GET /api/credits/products: "í¬ë ˆë”§ ìƒí’ˆ ëª©ë¡"
  POST /api/payments/kakaopay/ready: "ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ì¤€ë¹„"
  GET /api/payments/kakaopay/approve: "ê²°ì œ ìŠ¹ì¸"
  POST /api/payments/kakaopay/cancel: "ê²°ì œ ì·¨ì†Œ"
  
Credit:
  GET /api/credits/balance: "í¬ë ˆë”§ ì”ì•¡ ì¡°íšŒ"
  GET /api/credits/transactions: "ê±°ë˜ ë‚´ì—­"
  POST /api/credits/use: "í¬ë ˆë”§ ì‚¬ìš©"
```

### ğŸ”´ Internal APIs
```yaml
Internal:
  POST /api/internal/credits/add: "í¬ë ˆë”§ ì¶”ê°€"
  POST /api/internal/credits/deduct: "í¬ë ˆë”§ ì°¨ê°"
  GET /api/internal/credits/validate/{userId}: "ì”ì•¡ ìœ íš¨ì„± í™•ì¸"
```

---

## 7. â­ Review System Domain (ì¡°ë¯¼ê·€)

### ğŸ“Š Entities
```sql
-- ë¦¬ë·°
Review {
    id: BIGINT (PK)
    reviewer_id: BIGINT (FK â†’ User)
    reviewee_id: BIGINT (FK â†’ User)
    matching_id: BIGINT (FK â†’ Matching)
    trip_id: BIGINT (FK â†’ Trip)
    title: VARCHAR(255)
    content: TEXT
    rating: INT (1-5)
    helpful_count: INT DEFAULT 0
    status: ENUM('PENDING', 'APPROVED', 'HIDDEN')
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}

-- ë§¤ì¹­
Matching {
    id: BIGINT (PK)
    requester_id: BIGINT (FK â†’ User)
    responder_id: BIGINT (FK â†’ User)
    trip_id: BIGINT (FK â†’ Trip)
    status: ENUM('PENDING', 'ACCEPTED', 'REJECTED', 'COMPLETED')
    rejection_reason: TEXT
    completed_at: TIMESTAMP
    review_deadline: TIMESTAMP
    created_at: TIMESTAMP
}

-- ëŒ“ê¸€
Comment {
    id: BIGINT (PK)
    user_id: BIGINT (FK â†’ User)
    review_id: BIGINT (FK â†’ Review)
    feed_id: BIGINT (FK â†’ Feed)
    parent_comment_id: BIGINT (FK â†’ Comment)
    content: TEXT
    like_count: INT DEFAULT 0
    status: ENUM('ACTIVE', 'DELETED')
    created_at: TIMESTAMP
}

-- ì‹ ê³ 
Report {
    id: BIGINT (PK)
    reporter_id: BIGINT (FK â†’ User)
    reported_user_id: BIGINT (FK â†’ User)
    reported_review_id: BIGINT (FK â†’ Review)
    reported_comment_id: BIGINT (FK â†’ Comment)
    type: ENUM('SPAM', 'ABUSE', 'FAKE', 'INAPPROPRIATE')
    description: TEXT
    status: ENUM('PENDING', 'REVIEWED', 'RESOLVED')
    created_at: TIMESTAMP
}

-- í¬ì¸íŠ¸ ê±°ë˜
PointTransaction {
    id: BIGINT (PK)
    user_id: BIGINT (FK â†’ User)
    amount: INT
    type: VARCHAR(50)
    reference_id: BIGINT
    balance_after: INT
    created_at: TIMESTAMP
}

-- ë±ƒì§€
Badge {
    id: BIGINT (PK)
    name: VARCHAR(100)
    description: TEXT
    icon_url: VARCHAR(500)
    condition_type: VARCHAR(50)
    condition_value: INT
    created_at: TIMESTAMP
}

-- ì‚¬ìš©ì ë±ƒì§€
UserBadge {
    id: BIGINT (PK)
    user_id: BIGINT (FK â†’ User)
    badge_id: BIGINT (FK â†’ Badge)
    earned_at: TIMESTAMP
    UNIQUE(user_id, badge_id)
}
```

### ğŸ”µ External APIs
```yaml
Reviews:
  GET /api/reviews: "ë¦¬ë·° ëª©ë¡"
  POST /api/reviews: "ë¦¬ë·° ì‘ì„±"
  GET /api/reviews/{reviewId}: "ë¦¬ë·° ìƒì„¸"
  PUT /api/reviews/{reviewId}: "ë¦¬ë·° ìˆ˜ì •"
  POST /api/reviews/{reviewId}/helpful: "ë„ì›€ë¨ í‘œì‹œ"
  GET /api/reviews/best: "ë² ìŠ¤íŠ¸ ë¦¬ë·°"
  
Matching:
  GET /api/matchings: "ë§¤ì¹­ ëª©ë¡"
  POST /api/matchings: "ë§¤ì¹­ ìš”ì²­"
  PUT /api/matchings/{matchingId}/accept: "ë§¤ì¹­ ìˆ˜ë½"
  PUT /api/matchings/{matchingId}/reject: "ë§¤ì¹­ ê±°ì ˆ"
  PUT /api/matchings/{matchingId}/complete: "ë§¤ì¹­ ì™„ë£Œ"
  
Comments:
  GET /api/{type}/{id}/comments: "ëŒ“ê¸€ ëª©ë¡"
  POST /api/{type}/{id}/comments: "ëŒ“ê¸€ ì‘ì„±"
  DELETE /api/comments/{commentId}: "ëŒ“ê¸€ ì‚­ì œ"
  
Points & Badges:
  GET /api/points/balance: "í¬ì¸íŠ¸ ì”ì•¡"
  GET /api/points/history: "í¬ì¸íŠ¸ ë‚´ì—­"
  GET /api/badges: "íšë“í•œ ë±ƒì§€"
  
Reports:
  POST /api/reports: "ì‹ ê³ í•˜ê¸°"
  GET /api/reports/{reportId}: "ì‹ ê³  ìƒíƒœ ì¡°íšŒ"
```

### ğŸ”´ Internal APIs
```yaml
Internal:
  POST /api/internal/reviews/calculate-rating: "í‰ì  ì¬ê³„ì‚°"
  POST /api/internal/points/add: "í¬ì¸íŠ¸ ì¶”ê°€"
  POST /api/internal/badges/check: "ë±ƒì§€ ì¡°ê±´ ì²´í¬"
  POST /api/internal/spam/check: "ìŠ¤íŒ¸ ì²´í¬"
```

---

## 8. ğŸ“¸ Media Management Domain (ì¡°ë¯¼ê·€)

### ğŸ“Š Entities
```sql
-- í”¼ë“œ
Feed {
    id: BIGINT (PK)
    user_id: BIGINT (FK â†’ User)
    title: VARCHAR(255)
    content: TEXT
    view_count: INT DEFAULT 0
    like_count: INT DEFAULT 0
    comment_count: INT DEFAULT 0
    status: ENUM('PUBLISHED', 'HIDDEN', 'DELETED')
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}

-- ë¯¸ë””ì–´ íŒŒì¼
MediaFile {
    id: BIGINT (PK)
    uploader_id: BIGINT (FK â†’ User)
    original_filename: VARCHAR(255)
    storage_path: VARCHAR(500)
    file_type: ENUM('IMAGE', 'VIDEO')
    mime_type: VARCHAR(100)
    file_size: BIGINT
    width: INT
    height: INT
    duration: INT -- ë¹„ë””ì˜¤ ê¸¸ì´(ì´ˆ)
    thumbnail_url: VARCHAR(500)
    is_nsfw: BOOLEAN DEFAULT false
    virus_scan_status: ENUM('PENDING', 'CLEAN', 'INFECTED')
    created_at: TIMESTAMP
}

-- í”¼ë“œ ë¯¸ë””ì–´
FeedMedia {
    id: BIGINT (PK)
    feed_id: BIGINT (FK â†’ Feed)
    media_id: BIGINT (FK â†’ MediaFile)
    order_index: INT
    created_at: TIMESTAMP
    UNIQUE(feed_id, order_index)
}

-- ë¯¸ë””ì–´ íƒœê·¸
MediaTag {
    id: BIGINT (PK)
    media_id: BIGINT (FK â†’ MediaFile)
    tag: VARCHAR(100)
    confidence: DECIMAL(3,2) -- AI ì‹ ë¢°ë„
    source: ENUM('AI', 'USER', 'ADMIN')
    created_at: TIMESTAMP
}

-- í”¼ë“œ ì¢‹ì•„ìš”
FeedLike {
    id: BIGINT (PK)
    feed_id: BIGINT (FK â†’ Feed)
    user_id: BIGINT (FK â†’ User)
    created_at: TIMESTAMP
    UNIQUE(feed_id, user_id)
}
```

### ğŸ”µ External APIs
```yaml
Feeds:
  GET /api/feeds: "í”¼ë“œ ëª©ë¡"
  POST /api/feeds: "í”¼ë“œ ì‘ì„±"
  GET /api/feeds/{feedId}: "í”¼ë“œ ìƒì„¸"
  PUT /api/feeds/{feedId}: "í”¼ë“œ ìˆ˜ì •"
  DELETE /api/feeds/{feedId}: "í”¼ë“œ ì‚­ì œ"
  POST /api/feeds/{feedId}/like: "ì¢‹ì•„ìš”"
  DELETE /api/feeds/{feedId}/like: "ì¢‹ì•„ìš” ì·¨ì†Œ"
  
Media:
  POST /api/media/upload: "ë¯¸ë””ì–´ ì—…ë¡œë“œ"
  GET /api/media/{mediaId}: "ë¯¸ë””ì–´ ì¡°íšŒ"
  DELETE /api/media/{mediaId}: "ë¯¸ë””ì–´ ì‚­ì œ"
  GET /api/media/{mediaId}/thumbnail: "ì¸ë„¤ì¼ ì¡°íšŒ"
  
Tags:
  GET /api/media/{mediaId}/tags: "íƒœê·¸ ì¡°íšŒ"
  POST /api/media/{mediaId}/tags: "íƒœê·¸ ì¶”ê°€"
```

### ğŸ”´ Internal APIs
```yaml
Internal:
  POST /api/internal/media/scan-nsfw: "NSFW ìŠ¤ìº”"
  POST /api/internal/media/scan-virus: "ë°”ì´ëŸ¬ìŠ¤ ìŠ¤ìº”"
  POST /api/internal/media/generate-thumbnail: "ì¸ë„¤ì¼ ìƒì„±"
  POST /api/internal/media/extract-tags: "AI íƒœê·¸ ì¶”ì¶œ"
```

---

# ğŸ”— ë„ë©”ì¸ ê°„ ì˜ì¡´ê´€ê³„ ë° Core API ë§¤íŠ¸ë¦­ìŠ¤

## ì£¼ìš” ë„ë©”ì¸ ê°„ ì—°ê²°
```yaml
AI Client â†” Trip Planning:
  - AI Client: ì±„íŒ… ì»¨í…ìŠ¤íŠ¸ ì œê³µ
  - Trip Planning: AI ê¸°ë°˜ ì—¬í–‰ ê³„íš ìƒì„±
  - GET /api/chat/threads/{threadId}/context (AI Client â†’ Trip)
  - POST /api/trips/generate-from-chat (Tripì´ AI Client ì»¨í…ìŠ¤íŠ¸ í™œìš©)
  
AI Client â†’ Payment & Billing:
  - AI ì‚¬ìš© ì‹œ í¬ë ˆë”§ ì°¨ê°
  - POST /api/internal/credits/deduct
  
User Management â† All Domains:
  - ëª¨ë“  ë„ë©”ì¸ì—ì„œ ì¸ì¦/ì¸ê°€ í•„ìš”
  - GET /api/auth/verify
  - GET /api/internal/users/{userId}/permissions
  
Trip Planning â†’ Recommendation:
  - ì—¬í–‰ ê³„íš ì‹œ ì¶”ì²œ ì¥ì†Œ ì¡°íšŒ
  - GET /api/recommendations/places
  
Review System â†’ Trip Planning:
  - ë§¤ì¹­ëœ ì—¬í–‰ í›„ ë¦¬ë·° ì‘ì„±
  - GET /api/trips/{tripId}/participants
  
Media Management â†’ Review System:
  - ë¦¬ë·°ì— ë¯¸ë””ì–´ ì²¨ë¶€
  - POST /api/media/upload
  
Media Management â†’ AI Client:
  - ì±„íŒ…ì— ì´ë¯¸ì§€ ì²¨ë¶€
  - GET /api/media/{mediaId}
  
Sharing â†’ Trip Planning:
  - ì—¬í–‰ ê³„íš ê³µìœ 
  - GET /api/trips/{tripId}
  
Payment & Billing â†’ User Management:
  - ê²°ì œ í›„ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
  - PUT /api/internal/users/{userId}/credit-balance
  
Notification (Cross-cutting) â† All Domains:
  - ê° ë„ë©”ì¸ì—ì„œ ì•Œë¦¼ ë°œì†¡
  - POST /api/internal/notifications/send
```

## API í˜¸ì¶œ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: AIë¡œ ì—¬í–‰ ê³„íš ìƒì„± í›„ ê³µìœ 
```sequence
1. User â†’ Auth API: POST /api/auth/login
2. User â†’ AI Client API: POST /api/chat/threads
3. User â†’ AI Client API: POST /api/chat/threads/{id}/messages (ì—¬í–‰ ìš”êµ¬ì‚¬í•­ ëŒ€í™”)
4. AI Client â†’ Payment API: POST /api/internal/credits/validate
5. AI Client â†’ OpenAI Service: Generate Response
6. AI Client â†’ Payment API: POST /api/internal/credits/deduct
7. User â†’ AI Client API: POST /api/chat/threads/{id}/trip-request (ì—¬í–‰ ìƒì„± ìš”ì²­)
8. Trip Planning â†’ AI Client API: GET /api/chat/threads/{id}/context (ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ)
9. User â†’ Trip Planning API: POST /api/trips/generate-from-chat (AI ê¸°ë°˜ ì—¬í–‰ ìƒì„±)
10. Trip Planning â†’ AI Service: Process and Generate Trip Plan
11. Trip Planning â†’ User: Return Generated Trip
12. User â†’ Sharing API: POST /api/share/trips/{tripId}
13. Sharing â†’ Notification: POST /api/internal/notifications/send
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì—¬í–‰ ë§¤ì¹­ ë° ë¦¬ë·°
```sequence
1. User A â†’ Review API: POST /api/matchings (ë§¤ì¹­ ìš”ì²­)
2. Review â†’ Notification: POST /api/internal/notifications/send
3. User B â†’ Review API: PUT /api/matchings/{id}/accept
4. User B â†’ Trip API: POST /api/trips/{id}/participants
5. After trip completion...
6. User A â†’ Review API: POST /api/reviews
7. Review â†’ User API: PUT /api/internal/users/{userId}/rating
8. Review â†’ Points API: POST /api/internal/points/add
9. Review â†’ Badge API: POST /api/internal/badges/check
```

---

# ğŸ”’ ë³´ì•ˆ ë° ê¶Œí•œ ê´€ë¦¬

## API ì ‘ê·¼ ê¶Œí•œ ë ˆë²¨
```yaml
Public (ì¸ì¦ ë¶ˆí•„ìš”):
  - POST /api/auth/login
  - POST /api/users/signup
  - GET /api/auth/social/{provider}
  - GET /api/share/{token} (ê³µìœ  ë§í¬)

Protected (ì¼ë°˜ ì‚¬ìš©ì):
  - ìì‹ ì˜ ë°ì´í„° CRUD
  - ê³µê°œëœ í”¼ë“œ/ë¦¬ë·° ì¡°íšŒ
  - ë§¤ì¹­ ìš”ì²­/ì‘ë‹µ

Admin (ê´€ë¦¬ì):
  - ì‚¬ìš©ì ê´€ë¦¬
  - ì½˜í…ì¸  ëª¨ë”ë ˆì´ì…˜
  - ì‹œìŠ¤í…œ ì„¤ì •

Internal (ì„œë¹„ìŠ¤ ê°„):
  - /api/internal/* ì—”ë“œí¬ì¸íŠ¸
  - Service-to-Service í†µì‹ 
  - ë°°ì¹˜ ì‘ì—…
```

## ë°ì´í„° ì ‘ê·¼ ì œì–´
```yaml
Row-Level Security:
  - User: ìì‹ ì˜ ë°ì´í„°ë§Œ ì ‘ê·¼
  - Trip: ì°¸ì—¬ìë§Œ ì ‘ê·¼ (Owner > Editor > Viewer)
  - Review: ì‘ì„±ì ìˆ˜ì •, ëª¨ë‘ ì½ê¸°
  - Feed: ê³µê°œ/ë¹„ê³µê°œ ì„¤ì •
  
Column-Level Security:
  - Sensitive: password_hash, payment_info
  - PII: email, phone, address
  - Internal: trust_score, spam_score
```

---

# ğŸ“ˆ ì„±ëŠ¥ ìµœì í™” ì „ëµ

## ìºì‹± ê³„ì¸µ
```yaml
CDN Level:
  - Static Assets: ì´ë¯¸ì§€, CSS, JS
  - Media Files: ì¸ë„¤ì¼, í”„ë¡œí•„ ì´ë¯¸ì§€

Application Level (Redis):
  - Session: 30ë¶„ TTL
  - API Response: 5ë¶„ TTL
  - Hot Data: ìì£¼ ì¡°íšŒë˜ëŠ” í”¼ë“œ/ë¦¬ë·°

Database Level:
  - Place Cache: 7ì¼
  - Weather Cache: 1ì‹œê°„
  - AI Response Cache: 24ì‹œê°„
  - Recommendation Cache: 6ì‹œê°„
```

## ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤
```yaml
Primary Indexes:
  - User: email, nickname
  - Trip: owner_id, status
  - Feed: user_id, created_at
  - Review: reviewer_id, reviewee_id
  
Composite Indexes:
  - Trip: (owner_id, status, start_date)
  - Review: (reviewee_id, rating, created_at)
  - Feed: (user_id, status, created_at)
  - MediaFile: (uploader_id, file_type, created_at)
```

---

# ğŸš€ í™•ì¥ì„± ë° ë°°í¬

## ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜
```yaml
Core Services (ë„ë©”ì¸ë³„):
  - AI Service (AI Client Domain)
  - Auth Service (User Management)
  - Recommendation Service
  - Trip Service (Trip Planning)
  - Share Service (Sharing)
  - Payment Service (Payment & Billing)
  - Review Service (Review System)
  - Media Service (Media Management)

Supporting Services:
  - Notification Service (Cross-cutting)
  - Cache Service (Redis Cluster)
  - Queue Service (RabbitMQ/Kafka)
  - Search Service (Elasticsearch)
```

## ìŠ¤ì¼€ì¼ë§ ì „ëµ
```yaml
Horizontal Scaling:
  - ê° ì„œë¹„ìŠ¤ ë…ë¦½ì  ìŠ¤ì¼€ì¼ë§
  - Kubernetes HPA í™œìš©
  - Load Balancer ë¶„ì‚°

Vertical Scaling:
  - RDS Aurora ìë™ ìŠ¤ì¼€ì¼ë§
  - Redis Cluster í™•ì¥
  - ElastiCache í™œìš©

Database Optimization:
  - Read Replicas for ì½ê¸° ë¶€í•˜ ë¶„ì‚°
  - Sharding for ëŒ€ìš©ëŸ‰ í…Œì´ë¸” (Feed, Review)
  - Partitioning for ì‹œê³„ì—´ ë°ì´í„° (Logs)
```

---

# ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬

## ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§
```yaml
Performance Metrics:
  - API Response Time: P95 < 1ì´ˆ
  - Database Query Time: P99 < 100ms
  - Cache Hit Rate: > 80%
  
Availability:
  - Uptime: 99.9% SLA
  - Health Check: /health ì—”ë“œí¬ì¸íŠ¸
  - Circuit Breaker: ì¥ì•  ê²©ë¦¬
  
Business Metrics:
  - Daily Active Users
  - API Call Volume
  - Credit Usage
  - Content Creation Rate
```

## ë¡œê¹… ë° ê°ì‚¬
```yaml
Application Logs:
  - Request/Response ë¡œê¹…
  - Error Tracking (Sentry)
  - Performance Monitoring (APM)
  
Audit Logs:
  - User Actions
  - Admin Operations
  - Payment Transactions
  - Data Changes
```