# ğŸ¤– AI Client Domain ERD - ê¹€ë¯¼ì œ

## ğŸ“‹ ë‹´ë‹¹ ë„ë©”ì¸
- AI Client Domain: AI ì±„íŒ… ì¸í„°í˜ì´ìŠ¤, ëŒ€í™” ê´€ë¦¬

---

## ğŸ“Š Entities

### ì±„íŒ… ìŠ¤ë ˆë“œ
```sql
ChatThread {
    thread_id: UUID (PK)
    user_id: UUID (FK â†’ User Domain)
    title: VARCHAR(255)
    mode_id: INT (FK â†’ ChatMode)
    status: ENUM('active', 'archived', 'deleted')
    last_message_at: TIMESTAMP
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}
```

### ë©”ì‹œì§€
```sql
Message {
    message_id: UUID (PK)
    thread_id: UUID (FK â†’ ChatThread)
    sender_type: ENUM('user', 'ai')
    content: TEXT
    image_url: VARCHAR(500)
    location_lat: DECIMAL(10,8)
    location_lng: DECIMAL(11,8)
    tokens_used: INT
    parent_message_id: UUID (FK â†’ Message) -- ì¬ìƒì„±ìš©
    created_at: TIMESTAMP
}
```

### ì±„íŒ… ëª¨ë“œ
```sql
ChatMode {
    mode_id: INT (PK)
    name: VARCHAR(50)
    description: TEXT
    context_prompt: TEXT
    is_active: BOOLEAN
    created_at: TIMESTAMP
}
```

### ì±„íŒ… ì„¤ì •
```sql
ChatSettings {
    setting_id: UUID (PK)
    user_id: UUID (FK â†’ User Domain, UNIQUE)
    response_style: VARCHAR(50)
    language: VARCHAR(10)
    response_speed: ENUM('slow', 'normal', 'fast')
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}
```

### AI ì‘ë‹µ ìºì‹œ
```sql
AIResponse {
    response_id: UUID (PK)
    question_pattern: VARCHAR(500) (INDEX)
    response_content: TEXT
    ttl_expires_at: TIMESTAMP
    hit_count: INT DEFAULT 0
    created_at: TIMESTAMP
}
```

### API ì‚¬ìš©ëŸ‰ ë¡œê·¸
```sql
APIUsageLog {
    log_id: UUID (PK)
    user_id: UUID (FK â†’ User Domain)
    thread_id: UUID (FK â†’ ChatThread)
    tokens_used: INT
    api_cost: DECIMAL(10,4)
    api_endpoint: VARCHAR(255)
    created_at: TIMESTAMP
}
```

### ì±„íŒ…-ì—¬í–‰ ì—°ê²°
```sql
ChatTripLink {
    link_id: UUID (PK)
    thread_id: UUID (FK â†’ ChatThread)
    trip_id: UUID (FK â†’ Trip Planning Domain)
    created_at: TIMESTAMP
}
```

### ë¹ ë¥¸ ì œì•ˆ
```sql
QuickSuggestion {
    suggestion_id: INT (PK)
    title: VARCHAR(100)
    content: TEXT
    category: VARCHAR(50)
    display_order: INT
    is_active: BOOLEAN
    created_at: TIMESTAMP
}
```

---

## ğŸ”µ External APIs (ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)

### Chat Management
```yaml
GET /api/chat/threads:
  Description: "ì±„íŒ… ëª©ë¡ ì¡°íšŒ"
  Query: page, size, sort
  Response: ChatThreadListResponse
  
POST /api/chat/threads:
  Description: "ìƒˆ ì±„íŒ… ìƒì„±"
  Body: { title?, mode_id, initial_message? }
  Response: ChatThreadResponse
  
GET /api/chat/threads/{threadId}:
  Description: "ì±„íŒ… ìƒì„¸ ì¡°íšŒ"
  Response: ChatThreadDetailResponse
  
DELETE /api/chat/threads/{threadId}:
  Description: "ì±„íŒ… ì‚­ì œ"
  Response: 204 No Content
  
PUT /api/chat/threads/{threadId}/mode:
  Description: "ì±„íŒ… ëª¨ë“œ ë³€ê²½"
  Body: { mode_id }
  Response: ChatThreadResponse
  
PUT /api/chat/threads/{threadId}:
  Description: "ì±„íŒ… ì œëª© ìˆ˜ì •"
  Body: { title }
  Response: ChatThreadResponse
```

### Messages
```yaml
GET /api/chat/threads/{threadId}/messages:
  Description: "ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ"
  Query: page, size, lastMessageId
  Response: MessageListResponse
  
POST /api/chat/threads/{threadId}/messages:
  Description: "ë©”ì‹œì§€ ì „ì†¡"
  Body: { content, attachments? }
  Response: MessageResponse
  
POST /api/chat/threads/{threadId}/messages/image:
  Description: "ì´ë¯¸ì§€ ì²¨ë¶€ ë©”ì‹œì§€"
  Body: MultipartFile + MessageWithImageRequest
  Response: MessageResponse
  
POST /api/chat/threads/{threadId}/messages/location:
  Description: "ìœ„ì¹˜ ê³µìœ  ë©”ì‹œì§€"
  Body: { content, location: {lat, lng, address?} }
  Response: MessageResponse
  
POST /api/chat/threads/{threadId}/messages/{messageId}/regenerate:
  Description: "AI ì‘ë‹µ ì¬ìƒì„±"
  Response: MessageResponse
  
GET /api/chat/threads/{threadId}/messages/search:
  Description: "ë©”ì‹œì§€ ê²€ìƒ‰"
  Query: q, page, size
  Response: MessageSearchResponse
```

### AI Chat Context (Trip Planning Domainê³¼ ì—°ë™)
```yaml
GET /api/chat/threads/{threadId}/context:
  Description: "ì±„íŒ… ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ"
  Response: ChatContextResponse
  
POST /api/chat/threads/{threadId}/trip-request:
  Description: "ì—¬í–‰ ìƒì„± ìš”ì²­ ê¸°ë¡"
  Body: { request_type, metadata }
  Response: TripRequestResponse
```

### Settings & Suggestions
```yaml
GET /api/chat/settings:
  Description: "ì±„íŒ… ì„¤ì • ì¡°íšŒ"
  Response: ChatSettingsResponse
  
PUT /api/chat/settings:
  Description: "ì±„íŒ… ì„¤ì • ìˆ˜ì •"
  Body: { response_style?, language?, response_speed? }
  Response: ChatSettingsResponse
  
GET /api/chat/suggestions:
  Description: "ë¹ ë¥¸ ì œì•ˆ ì¡°íšŒ"
  Query: category?
  Response: QuickSuggestionListResponse
  
GET /api/chat/modes:
  Description: "ì±„íŒ… ëª¨ë“œ ëª©ë¡"
  Response: ChatModeListResponse
```

### Usage & Statistics
```yaml
GET /api/chat/usage:
  Description: "í¬ë ˆë”§ ì‚¬ìš©ëŸ‰ ì¡°íšŒ"
  Query: period (daily/monthly)
  Response: CreditUsageResponse
  
GET /api/chat/api-usage:
  Description: "API ì‚¬ìš© í†µê³„"
  Query: startDate, endDate
  Response: APIUsageStatisticsResponse
```

---

## ğŸ”´ Internal APIs (ë„ë©”ì¸ ë‚´ë¶€ìš©)

```yaml
POST /api/internal/chat/cache-response:
  Description: "AI ì‘ë‹µ ìºì‹±"
  Body: { pattern, response, ttl }
  
GET /api/internal/chat/cache/{pattern}:
  Description: "ìºì‹œ ì¡°íšŒ"
  Response: CachedResponse
  
POST /api/internal/chat/log-usage:
  Description: "ì‚¬ìš©ëŸ‰ ë¡œê¹…"
  Body: { user_id, tokens, cost, endpoint }
  
DELETE /api/internal/chat/cache/expired:
  Description: "ë§Œë£Œ ìºì‹œ ì •ë¦¬"
  
GET /api/internal/chat/thread/{threadId}/validation:
  Description: "ìŠ¤ë ˆë“œ ìœ íš¨ì„± ê²€ì¦"
```

---

## ğŸ”— ì™¸ë¶€ ë„ë©”ì¸ ì˜ì¡´ì„±

### í•„ìš”í•œ ì™¸ë¶€ API
```yaml
User Management Domain:
  - GET /api/users/{userId}: "ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ"
  - GET /api/auth/verify: "í† í° ê²€ì¦"
  
Payment & Billing Domain:
  - POST /api/internal/credits/validate: "í¬ë ˆë”§ ì”ì•¡ í™•ì¸"
  - POST /api/internal/credits/deduct: "í¬ë ˆë”§ ì°¨ê°"
  
Trip Planning Domain:
  - POST /api/trips/generate-from-chat: "AI ê¸°ë°˜ ì—¬í–‰ ìƒì„±"
  - GET /api/internal/trips/chat/{threadId}: "ì±„íŒ… ì—°ê´€ ì—¬í–‰ ì¡°íšŒ"
  
Media Management Domain:
  - POST /api/media/upload: "ì´ë¯¸ì§€ ì—…ë¡œë“œ"
  - GET /api/media/{mediaId}: "ë¯¸ë””ì–´ ì¡°íšŒ"
```

---

## ğŸ“ DTO ì •ì˜

### Request DTOs
```typescript
CreateChatThreadRequest {
  title?: string
  mode_id: number
  initial_message?: string
}

SendMessageRequest {
  content: string
  attachments?: {
    image_url?: string
    location?: {
      lat: number
      lng: number
    }
  }
}

UpdateChatSettingsRequest {
  response_style?: string
  language?: string
  response_speed?: 'slow' | 'normal' | 'fast'
}
```

### Response DTOs
```typescript
ChatThreadResponse {
  thread_id: string
  title: string
  mode: {
    mode_id: number
    name: string
  }
  status: string
  last_message?: {
    content: string
    created_at: string
  }
  created_at: string
}

MessageResponse {
  message_id: string
  thread_id: string
  sender_type: 'user' | 'ai'
  content: string
  image_url?: string
  location?: {
    lat: number
    lng: number
  }
  tokens_used: number
  created_at: string
}

ChatContextResponse {
  thread_id: string
  messages: MessageResponse[]
  mode: ChatModeDto
  user_preferences: object
  trip_context?: object
}
```

---

## ğŸ’¡ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

1. **AI ì‘ë‹µ ìƒì„± í”Œë¡œìš°**
   - ì‚¬ìš©ì ë©”ì‹œì§€ ìˆ˜ì‹  â†’ í¬ë ˆë”§ í™•ì¸ â†’ OpenAI API í˜¸ì¶œ â†’ ì‘ë‹µ ìºì‹± â†’ í¬ë ˆë”§ ì°¨ê° â†’ ì‘ë‹µ ì „ì†¡

2. **ìºì‹± ì „ëµ**
   - ìœ ì‚¬ ì§ˆë¬¸ íŒ¨í„´ ê°ì§€ â†’ ìºì‹œ ì¡°íšŒ â†’ TTL í™•ì¸ â†’ ìºì‹œ íˆíŠ¸ ì‹œ ì¦‰ì‹œ ì‘ë‹µ

3. **ì—¬í–‰ ê³„íš ì—°ë™**
   - ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ì¶•ì  â†’ ì—¬í–‰ ìƒì„± ìš”ì²­ â†’ Trip Planning Domain í˜¸ì¶œ â†’ ê²°ê³¼ ì—°ê²°

4. **í† í° ê´€ë¦¬**
   - ë©”ì‹œì§€ë³„ í† í° ì‚¬ìš©ëŸ‰ ì¶”ì  â†’ ì¼/ì›” ë‹¨ìœ„ ì§‘ê³„ â†’ í¬ë ˆë”§ ì†Œë¹„ ê³„ì‚°

---

## ğŸ” ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

- JWT í† í° ê¸°ë°˜ ì¸ì¦
- ë©”ì‹œì§€ ë‚´ìš© ì•”í˜¸í™” ì €ì¥
- API Rate Limiting
- í¬ë ˆë”§ ì”ì•¡ ê²€ì¦
- XSS/SQL Injection ë°©ì–´