openapi: 3.0.3
info:
  title: Compass User Domain API
  description: |
    # User ë„ë©”ì¸ API ëª…ì„¸ì„œ (v2.0)
    
    ## ğŸ“‹ ë„ë©”ì¸ êµ¬ì„± ìš”ì•½
    
    ### User ë„ë©”ì¸ì´ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤
    - **í•µì‹¬ API (Core)**: í´ë¼ì´ì–¸íŠ¸(ì›¹/ì•±)ë¥¼ ìœ„í•œ ì‚¬ìš©ì ì¸ì¦ ë° ê³„ì • ê´€ë¦¬ ê¸°ëŠ¥
    - **ë‚´ë¶€ API (Internal)**: ë‹¤ë¥¸ ë°±ì—”ë“œ ë„ë©”ì¸ì„ ìœ„í•œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ë° í† í° ê²€ì¦ ê¸°ëŠ¥
    
    ## ğŸ“Š ë„ë©”ì¸ ê°„ ìƒí˜¸ì‘ìš©
    
    | ë„ë©”ì¸ | User â†’ ì™¸ë¶€ (ìš”ì²­) | ì™¸ë¶€ â†’ User (í˜¸ì¶œ) | ì£¼ìš” ìš©ë„ |
    |---|---|---|---|
    | **(Self)** | - | (All Domains) | ì‚¬ìš©ì ì¸ì¦/ê³„ì • ê´€ë¦¬ ê¸°ëŠ¥ ì œê³µ |
    | **Notification** | â€¢ ì´ë©”ì¼ ë°œì†¡ ìš”ì²­ | - | íšŒì›ê°€ì… í™˜ì˜, ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë“± |
    
    ## ğŸ“Œ API ë¶„ë¥˜
    
    | ë¶„ë¥˜ | ì„¤ëª… | íƒœê·¸ |
    |---|---|---|
    | **User Core** | ì‚¬ìš©ìê°€ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” í•µì‹¬ API | User - Core |
    | **User Internal** | ë‹¤ë¥¸ ë„ë©”ì¸ì´ í˜¸ì¶œí•˜ëŠ” ë‚´ë¶€ API | User - Internal |
    | **External APIs**| Userê°€ ì˜ì¡´í•˜ëŠ” ì™¸ë¶€ ë„ë©”ì¸ API | External - * |
  version: 2.0.0
  contact:
    name: User Domain Team
    email: user-team@compass.com

servers:
  - url: https://api.compass.com/v1
    description: Production Server
  - url: http://localhost:8080/v1
    description: Development Server

tags:
  - name: User - Core
    description: ì‚¬ìš©ì ì¸ì¦ ë° ê³„ì • ê´€ë¦¬ API (í´ë¼ì´ì–¸íŠ¸ ëŒ€ìƒ)
  - name: User - Internal
    description: ì„œë²„ ê°„ í†µì‹ ìš© ë‚´ë¶€ API (ë‹¤ë¥¸ ë„ë©”ì¸ ëŒ€ìƒ)
  - name: External - Notification Domain
    description: Notification ë„ë©”ì¸ ì˜ì¡´ì„±

x-events-published:
  UserSignedUp:
    description: ì‹ ê·œ ì‚¬ìš©ì ê°€ì… ì´ë²¤íŠ¸
    consumers: [Notification, Analytics, Recommendation]
    payload: { userId: uuid, email: string, nickname: string, timestamp: datetime }
  ProfileUpdated:
    description: ì‚¬ìš©ì í”„ë¡œí•„ ë³€ê²½ ì´ë²¤íŠ¸
    consumers: [Recommendation, Analytics]
    payload: { userId: uuid, updatedFields: [string], timestamp: datetime }

paths:
  # ============================================
  # == 1. User Domain - Core APIs
  # ============================================
  /users/signup:
    post:
      tags: [User - Core]
      summary: íšŒì›ê°€ì…
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-001
      operationId: signUpUser
      requestBody:
        $ref: '#/components/requestBodies/SignUpRequest'
      responses:
        '201':
          $ref: '#/components/responses/UserResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '409':
          $ref: '#/components/responses/ConflictError'

  /auth/login:
    post:
      tags: [User - Core]
      summary: ë¡œê·¸ì¸
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-002, REJ-USER-003
      operationId: loginUser
      requestBody:
        $ref: '#/components/requestBodies/LoginRequest'
      responses:
        '200':
          $ref: '#/components/responses/TokenResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/logout:
    post:
      tags: [User - Core]
      summary: ë¡œê·¸ì•„ì›ƒ
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-002
      operationId: logoutUser
      security:
        - bearerAuth: []
      requestBody:
        $ref: '#/components/requestBodies/RefreshTokenRequest'
      responses:
        '204':
          description: No Content

  /auth/refresh:
    post:
      tags: [User - Core]
      summary: í† í° ê°±ì‹ 
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-003
      operationId: refreshAccessToken
      requestBody:
        $ref: '#/components/requestBodies/RefreshTokenRequest'
      responses:
        '200':
          $ref: '#/components/responses/AccessTokenResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/social/{provider}:
    get:
      tags: [User - Core]
      summary: ì†Œì…œ ë¡œê·¸ì¸
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-008
      operationId: handleSocialLogin
      parameters:
        - $ref: '#/components/parameters/provider'
      responses:
        '302':
          description: ì†Œì…œ ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
        '200':
          description: ì½œë°± ì²˜ë¦¬ í›„ í† í° ë°œê¸‰
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'

  /users/me:
    get:
      tags: [User - Core]
      summary: ë‚´ í”„ë¡œí•„ ì¡°íšŒ
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-004
      operationId: getMyProfile
      security:
        - bearerAuth: []
      responses:
        '200':
          $ref: '#/components/responses/UserProfileResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    put:
      tags: [User - Core]
      summary: ë‚´ í”„ë¡œí•„ ìˆ˜ì •
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-004
      operationId: updateMyProfile
      security:
        - bearerAuth: []
      requestBody:
        $ref: '#/components/requestBodies/UpdateProfileRequest'
      responses:
        '200':
          $ref: '#/components/responses/UserProfileResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '409':
          $ref: '#/components/responses/ConflictError'
    delete:
      tags: [User - Core]
      summary: íšŒì› íƒˆí‡´
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-011
      operationId: withdrawUser
      security:
        - bearerAuth: []
      requestBody:
        $ref: '#/components/requestBodies/WithdrawalRequest'
      responses:
        '204':
          description: No Content
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /users/password/reset-request:
    post:
      tags: [User - Core]
      summary: ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-005
      operationId: requestPasswordReset
      requestBody:
        $ref: '#/components/requestBodies/PasswordResetRequest'
      responses:
        '204':
          description: No Content

  /users/password/reset:
    post:
      tags: [User - Core]
      summary: ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-005
      operationId: setNewPassword
      requestBody:
        $ref: '#/components/requestBodies/NewPasswordRequest'
      responses:
        '204':
          description: No Content

  /users/me/security/2fa:
    post:
      tags: [User - Core]
      summary: 2ë‹¨ê³„ ì¸ì¦ ì„¤ì •
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-009
      operationId: toggle2FA
      security:
        - bearerAuth: []
      requestBody:
        $ref: '#/components/requestBodies/Toggle2FARequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                properties:
                  is2faEnabled: { type: boolean }

  /users/me/login-history:
    get:
      tags: [User - Core]
      summary: ë¡œê·¸ì¸ ê¸°ë¡ ì¡°íšŒ
      description: |
        - **ìš”êµ¬ì‚¬í•­ ID**: REJ-USER-009
      operationId: getLoginHistory
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LoginHistoryResponse'

  # ============================================
  # == 2. User Domain - Internal APIs
  # ============================================
  /internal/users/{userId}:
    get:
      tags: [User - Internal]
      summary: ë‚´ë¶€ìš© ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
      description: ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œ ì„œë²„ ê°„ í†µì‹ ìœ¼ë¡œ íŠ¹ì • ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
      operationId: getUserInfoInternal
      security:
        - internalApiKey: []
      parameters:
        - $ref: '#/components/parameters/userId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'

  # ============================================
  # == 3. External Dependencies
  # ============================================
  /notifications/send:
    post:
      tags: [External - Notification Domain]
      summary: '[Notification Domain] ì´ë©”ì¼ ë°œì†¡'
      description: "âš ï¸ Notification ë„ë©”ì¸ì´ ì œê³µí•´ì•¼ í•˜ëŠ” API. íšŒì›ê°€ì…, ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì‹œ í˜¸ì¶œ."
      operationId: sendEmailExternal
      x-external-api: true
      x-provided-by: Notification Domain
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendEmailRequest'
      responses:
        '202':
          description: Accepted

components:
  securitySchemes:
    bearerAuth: { type: http, scheme: bearer, bearerFormat: JWT }
    internalApiKey: { type: apiKey, in: header, name: X-Internal-API-Key }
  parameters:
    userId: { name: userId, in: path, required: true, schema: { type: string, format: uuid } }
    provider: { name: provider, in: path, required: true, schema: { type: string, enum: [google, kakao] } }
  schemas:
    # --- Request DTOs ---
    SignUpRequest: { type: object, required: [email, password, nickname], properties: { email: { type: string, format: email }, password: { type: string, format: password, minLength: 8 }, nickname: { type: string } } }
    LoginRequest: { type: object, required: [email, password], properties: { email: { type: string, format: email }, password: { type: string, format: password } } }
    RefreshTokenRequest: { type: object, properties: { refreshToken: { type: string } } }
    UpdateProfileRequest: { type: object, properties: { nickname: { type: string }, preferredRegion: { type: string } } }
    PasswordResetRequest: { type: object, required: [email], properties: { email: { type: string, format: email } } }
    NewPasswordRequest: { type: object, required: [token, newPassword], properties: { token: { type: string }, newPassword: { type: string, format: password } } }
    Toggle2FARequest: { type: object, required: [enable], properties: { enable: { type: boolean } } }
    WithdrawalRequest: { type: object, required: [password], properties: { password: { type: string, format: password } } }
    # --- Response DTOs ---
    UserResponse: { type: object, properties: { id: { type: string, format: uuid }, email: { type: string, format: email }, nickname: { type: string }, createdAt: { type: string, format: date-time } } }
    UserProfileResponse: { type: object, properties: { id: { type: string, format: uuid }, email: { type: string, format: email }, nickname: { type: string }, profileImageUrl: { type: string, format: uri, nullable: true }, preferredRegion: { type: string, nullable: true } } }
    TokenResponse: { type: object, properties: { accessToken: { type: string }, refreshToken: { type: string } } }
    AccessTokenResponse: { type: object, properties: { accessToken: { type: string } } }
    LoginHistoryResponse: { type: object, properties: { ipAddress: { type: string }, deviceInfo: { type: string }, loginAt: { type: string, format: date-time } } }
    # --- External DTOs ---
    SendEmailRequest: { type: object, properties: { to: { type: string, format: email }, templateId: { type: string }, variables: { type: object } } }
    ErrorResponse: { type: object, properties: { code: { type: string }, message: { type: string }, timestamp: { type: string, format: date-time } } }
  requestBodies:
    SignUpRequest: { required: true, content: { application/json: { schema: { $ref: '#/components/schemas/SignUpRequest' } } } }
    LoginRequest: { required: true, content: { application/json: { schema: { $ref: '#/components/schemas/LoginRequest' } } } }
    RefreshTokenRequest: { required: true, content: { application/json: { schema: { $ref: '#/components/schemas/RefreshTokenRequest' } } } }
    UpdateProfileRequest: { required: true, content: { application/json: { schema: { $ref: '#/components/schemas/UpdateProfileRequest' } } } }
    PasswordResetRequest: { required: true, content: { application/json: { schema: { $ref: '#/components/schemas/PasswordResetRequest' } } } }
    NewPasswordRequest: { required: true, content: { application/json: { schema: { $ref: '#/components/schemas/NewPasswordRequest' } } } }
    Toggle2FARequest: { required: true, content: { application/json: { schema: { $ref: '#/components/schemas/Toggle2FARequest' } } } }
    WithdrawalRequest: { required: true, content: { application/json: { schema: { $ref: '#/components/schemas/WithdrawalRequest' } } } }
  responses:
    UserResponse: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/UserResponse' } } } }
    UserProfileResponse: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/UserProfileResponse' } } } }
    TokenResponse: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/TokenResponse' } } } }
    AccessTokenResponse: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/AccessTokenResponse' } } } }
    BadRequestError: { description: ì˜ëª»ëœ ìš”ì²­, content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }, example: { code: "VALIDATION_ERROR", message: "ìš”ì²­ ê°’ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." } } } }
    UnauthorizedError: { description: ì¸ì¦ ì‹¤íŒ¨, content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }, example: { code: "AUTH_001", message: "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤." } } } }
    NotFoundError: { description: ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }, example: { code: "USER_404", message: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." } } } }
    ConflictError: { description: ì¶©ëŒ ë°œìƒ, content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' }, example: { code: "USER_009", message: "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤." } } } }