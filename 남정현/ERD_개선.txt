# ğŸ”„ Sharing & Payment Domains ERD - ë‚¨ì •í˜„

## ğŸ“‹ ë‹´ë‹¹ ë„ë©”ì¸
1. Sharing Domain: ì½˜í…ì¸  ê³µìœ , ì†Œì…œ ê¸°ëŠ¥
2. Payment & Billing Domain: ê²°ì œ, í¬ë ˆë”§ ê´€ë¦¬, êµ¬ë…

---

# Domain 1: Sharing

## ğŸ“Š Entities

### ê³µìœ  ì½˜í…ì¸ 
```sql
SharedContent {
    share_id: UUID (PK)
    content_type: ENUM('trip', 'review', 'media')
    content_id: UUID
    shared_by: UUID (FK â†’ User Management Domain)
    share_url: VARCHAR(500) (UNIQUE)
    share_code: VARCHAR(20) (UNIQUE)
    visibility: ENUM('public', 'link_only', 'private')
    expires_at: TIMESTAMP
    view_count: INT DEFAULT 0
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}
```

### ê³µìœ  ì ‘ê·¼ ê¶Œí•œ
```sql
ShareAccess {
    access_id: UUID (PK)
    share_id: UUID (FK â†’ SharedContent)
    user_id: UUID (FK â†’ User Management Domain)
    permission: ENUM('view', 'comment', 'edit')
    accessed_at: TIMESTAMP
    created_at: TIMESTAMP
}
```

### ì†Œì…œ í”¼ë“œ
```sql
SocialFeed {
    feed_id: UUID (PK)
    user_id: UUID (FK â†’ User Management Domain)
    content_type: VARCHAR(50)
    content_id: UUID
    action: VARCHAR(50)
    visibility: ENUM('public', 'friends', 'private')
    created_at: TIMESTAMP
}
```

### íŒ”ë¡œìš°
```sql
Follow {
    follow_id: UUID (PK)
    follower_id: UUID (FK â†’ User Management Domain)
    following_id: UUID (FK â†’ User Management Domain)
    created_at: TIMESTAMP
    UNIQUE KEY (follower_id, following_id)
}
```

### ê³µìœ  í†µê³„
```sql
ShareStatistics {
    stat_id: UUID (PK)
    share_id: UUID (FK â†’ SharedContent)
    date: DATE
    view_count: INT DEFAULT 0
    unique_viewers: INT DEFAULT 0
    share_count: INT DEFAULT 0
    created_at: TIMESTAMP
}
```

## ğŸ”µ External APIs (Sharing Domain)

### Share Management
```yaml
POST /api/share/content:
  Description: "ì½˜í…ì¸  ê³µìœ "
  Body: { content_type, content_id, visibility, expires_in_hours? }
  Response: ShareResponse
  
GET /api/share/{shareCode}:
  Description: "ê³µìœ  ì½˜í…ì¸  ì¡°íšŒ"
  Response: SharedContentResponse
  
PUT /api/share/{shareId}:
  Description: "ê³µìœ  ì„¤ì • ìˆ˜ì •"
  Body: { visibility?, expires_at? }
  Response: ShareResponse
  
DELETE /api/share/{shareId}:
  Description: "ê³µìœ  ì·¨ì†Œ"
  Response: 204 No Content
  
POST /api/share/{shareId}/access:
  Description: "ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬"
  Body: { user_id, permission }
  Response: ShareAccessResponse
```

### Social Features
```yaml
GET /api/social/feed:
  Description: "ì†Œì…œ í”¼ë“œ ì¡°íšŒ"
  Query: page, size, filter?
  Response: SocialFeedResponse
  
POST /api/social/follow:
  Description: "ì‚¬ìš©ì íŒ”ë¡œìš°"
  Body: { user_id }
  Response: FollowResponse
  
DELETE /api/social/follow/{userId}:
  Description: "ì–¸íŒ”ë¡œìš°"
  Response: 204 No Content
  
GET /api/social/followers:
  Description: "íŒ”ë¡œì›Œ ëª©ë¡"
  Query: page, size
  Response: FollowerListResponse
  
GET /api/social/following:
  Description: "íŒ”ë¡œì‰ ëª©ë¡"
  Query: page, size
  Response: FollowingListResponse
```

### Share Statistics
```yaml
GET /api/share/{shareId}/stats:
  Description: "ê³µìœ  í†µê³„"
  Query: period?
  Response: ShareStatisticsResponse
  
POST /api/share/{shareId}/view:
  Description: "ì¡°íšŒìˆ˜ ì¦ê°€"
  Response: { view_count: number }
```

## ğŸ”´ Internal APIs (Sharing Domain)

```yaml
POST /api/internal/share/validate:
  Description: "ê³µìœ  ìœ íš¨ì„± ê²€ì¦"
  Body: { share_id, user_id }
  
POST /api/internal/share/cleanup:
  Description: "ë§Œë£Œëœ ê³µìœ  ì •ë¦¬"
  
GET /api/internal/share/user/{userId}:
  Description: "ì‚¬ìš©ì ê³µìœ  ëª©ë¡"
  Response: UserSharesResponse
```

---

# Domain 2: Payment & Billing

## ğŸ“Š Entities

### ì‚¬ìš©ì í¬ë ˆë”§
```sql
UserCredit {
    credit_id: UUID (PK)
    user_id: UUID (FK â†’ User Management Domain, UNIQUE)
    balance: DECIMAL(10,2)
    bonus_balance: DECIMAL(10,2)
    total_earned: DECIMAL(10,2)
    total_spent: DECIMAL(10,2)
    updated_at: TIMESTAMP
    created_at: TIMESTAMP
}
```

### í¬ë ˆë”§ ê±°ë˜
```sql
CreditTransaction {
    transaction_id: UUID (PK)
    user_id: UUID (FK â†’ User Management Domain)
    type: ENUM('purchase', 'usage', 'refund', 'bonus')
    amount: DECIMAL(10,2)
    balance_after: DECIMAL(10,2)
    description: TEXT
    reference_id: VARCHAR(255)
    created_at: TIMESTAMP
}
```

### êµ¬ë… í”Œëœ
```sql
SubscriptionPlan {
    plan_id: UUID (PK)
    name: VARCHAR(100)
    description: TEXT
    price: DECIMAL(10,2)
    credits_included: INT
    features: JSON
    billing_period: ENUM('monthly', 'yearly')
    is_active: BOOLEAN DEFAULT true
    created_at: TIMESTAMP
}
```

### ì‚¬ìš©ì êµ¬ë…
```sql
UserSubscription {
    subscription_id: UUID (PK)
    user_id: UUID (FK â†’ User Management Domain)
    plan_id: UUID (FK â†’ SubscriptionPlan)
    status: ENUM('active', 'cancelled', 'expired', 'paused')
    start_date: DATE
    end_date: DATE
    auto_renew: BOOLEAN DEFAULT true
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}
```

### ê²°ì œ ê¸°ë¡
```sql
Payment {
    payment_id: UUID (PK)
    user_id: UUID (FK â†’ User Management Domain)
    amount: DECIMAL(10,2)
    currency: VARCHAR(3)
    payment_method: VARCHAR(50)
    payment_gateway: VARCHAR(50)
    gateway_transaction_id: VARCHAR(255)
    status: ENUM('pending', 'completed', 'failed', 'refunded')
    metadata: JSON
    created_at: TIMESTAMP
    completed_at: TIMESTAMP
}
```

### í¬ë ˆë”§ íŒ¨í‚¤ì§€
```sql
CreditPackage {
    package_id: UUID (PK)
    name: VARCHAR(100)
    credits: INT
    price: DECIMAL(10,2)
    bonus_credits: INT DEFAULT 0
    is_active: BOOLEAN DEFAULT true
    created_at: TIMESTAMP
}
```

### ì‚¬ìš©ëŸ‰ ë¡œê·¸
```sql
UsageLog {
    log_id: UUID (PK)
    user_id: UUID (FK â†’ User Management Domain)
    service_type: VARCHAR(50)
    credits_used: INT
    metadata: JSON
    created_at: TIMESTAMP
}
```

### ì²­êµ¬ì„œ
```sql
Invoice {
    invoice_id: UUID (PK)
    user_id: UUID (FK â†’ User Management Domain)
    subscription_id: UUID (FK â†’ UserSubscription)
    amount: DECIMAL(10,2)
    tax: DECIMAL(10,2)
    total: DECIMAL(10,2)
    status: ENUM('draft', 'sent', 'paid', 'overdue')
    due_date: DATE
    paid_at: TIMESTAMP
    created_at: TIMESTAMP
}
```

## ğŸ”µ External APIs (Payment & Billing Domain)

### Credit Management
```yaml
GET /api/credits/balance:
  Description: "í¬ë ˆë”§ ì”ì•¡ ì¡°íšŒ"
  Response: CreditBalanceResponse
  
POST /api/credits/purchase:
  Description: "í¬ë ˆë”§ êµ¬ë§¤"
  Body: { package_id, payment_method }
  Response: PurchaseResponse
  
GET /api/credits/transactions:
  Description: "ê±°ë˜ ë‚´ì—­ ì¡°íšŒ"
  Query: page, size, type?
  Response: TransactionListResponse
  
GET /api/credits/packages:
  Description: "í¬ë ˆë”§ íŒ¨í‚¤ì§€ ëª©ë¡"
  Response: CreditPackageListResponse
```

### Subscription Management
```yaml
GET /api/subscriptions/plans:
  Description: "êµ¬ë… í”Œëœ ëª©ë¡"
  Response: SubscriptionPlanListResponse
  
POST /api/subscriptions/subscribe:
  Description: "êµ¬ë… ì‹œì‘"
  Body: { plan_id, payment_method }
  Response: SubscriptionResponse
  
PUT /api/subscriptions/cancel:
  Description: "êµ¬ë… ì·¨ì†Œ"
  Response: SubscriptionCancelResponse
  
PUT /api/subscriptions/pause:
  Description: "êµ¬ë… ì¼ì‹œì •ì§€"
  Response: SubscriptionPauseResponse
  
PUT /api/subscriptions/resume:
  Description: "êµ¬ë… ì¬ê°œ"
  Response: SubscriptionResumeResponse
  
GET /api/subscriptions/status:
  Description: "êµ¬ë… ìƒíƒœ ì¡°íšŒ"
  Response: SubscriptionStatusResponse
```

### Payment & Billing
```yaml
POST /api/payments/process:
  Description: "ê²°ì œ ì²˜ë¦¬"
  Body: { amount, payment_method, metadata }
  Response: PaymentResponse
  
GET /api/payments/history:
  Description: "ê²°ì œ ë‚´ì—­"
  Query: page, size, status?
  Response: PaymentHistoryResponse
  
POST /api/payments/refund:
  Description: "í™˜ë¶ˆ ìš”ì²­"
  Body: { payment_id, reason }
  Response: RefundResponse
  
GET /api/invoices:
  Description: "ì²­êµ¬ì„œ ëª©ë¡"
  Query: page, size, status?
  Response: InvoiceListResponse
  
GET /api/invoices/{invoiceId}:
  Description: "ì²­êµ¬ì„œ ìƒì„¸"
  Response: InvoiceDetailResponse
```

### Usage Tracking
```yaml
GET /api/usage/summary:
  Description: "ì‚¬ìš©ëŸ‰ ìš”ì•½"
  Query: period
  Response: UsageSummaryResponse
  
GET /api/usage/details:
  Description: "ìƒì„¸ ì‚¬ìš© ë‚´ì—­"
  Query: start_date, end_date, service_type?
  Response: UsageDetailResponse
```

## ğŸ”´ Internal APIs (Payment & Billing Domain)

```yaml
POST /api/internal/credits/validate:
  Description: "í¬ë ˆë”§ ì”ì•¡ í™•ì¸"
  Body: { user_id, required_credits }
  Response: { sufficient: boolean, balance: number }
  
POST /api/internal/credits/deduct:
  Description: "í¬ë ˆë”§ ì°¨ê°"
  Body: { user_id, amount, service_type, reference_id }
  Response: { success: boolean, balance_after: number }
  
POST /api/internal/credits/add:
  Description: "í¬ë ˆë”§ ì¶”ê°€"
  Body: { user_id, amount, type, description }
  
POST /api/internal/usage/log:
  Description: "ì‚¬ìš©ëŸ‰ ê¸°ë¡"
  Body: { user_id, service_type, credits_used, metadata }
  
GET /api/internal/subscription/check:
  Description: "êµ¬ë… ìƒíƒœ í™•ì¸"
  Query: user_id
  Response: { active: boolean, plan_details: object }
  
POST /api/internal/billing/generate-invoice:
  Description: "ì²­êµ¬ì„œ ìƒì„±"
  Body: { user_id, subscription_id, period }
```

---

## ğŸ”— ì™¸ë¶€ ë„ë©”ì¸ ì˜ì¡´ì„±

### í•„ìš”í•œ ì™¸ë¶€ API
```yaml
User Management Domain:
  - GET /api/users/{userId}: "ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ"
  - GET /api/internal/users/validate: "ì‚¬ìš©ì ìœ íš¨ì„± ê²€ì¦"
  
Trip Planning Domain:
  - GET /api/trips/{tripId}: "ì—¬í–‰ ì •ë³´ ì¡°íšŒ (ê³µìœ ìš©)"
  - GET /api/internal/trips/validate: "ì—¬í–‰ ìœ íš¨ì„± ê²€ì¦"
  
Review System Domain:
  - GET /api/reviews/{reviewId}: "ë¦¬ë·° ì •ë³´ ì¡°íšŒ (ê³µìœ ìš©)"
  
Media Management Domain:
  - GET /api/media/{mediaId}: "ë¯¸ë””ì–´ ì •ë³´ ì¡°íšŒ (ê³µìœ ìš©)"
  
AI Client Domain:
  - GET /api/chat/usage: "AI ì‚¬ìš©ëŸ‰ ì¡°íšŒ"
```

---

## ğŸ’¡ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

### Sharing Domain
1. **ì½˜í…ì¸  ê³µìœ  í”Œë¡œìš°**: ê³µìœ  ìƒì„± â†’ ê³ ìœ  ë§í¬ ìƒì„± â†’ ì ‘ê·¼ ê¶Œí•œ ì„¤ì • â†’ í†µê³„ ì¶”ì 
2. **ì†Œì…œ í”¼ë“œ ì•Œê³ ë¦¬ì¦˜**: íŒ”ë¡œìš° ê´€ê³„ â†’ í™œë™ ìˆ˜ì§‘ â†’ í”¼ë“œ êµ¬ì„± â†’ ê°œì¸í™” í‘œì‹œ
3. **ê³µìœ  ë§Œë£Œ ê´€ë¦¬**: ë§Œë£Œ ì‹œê°„ ì¶”ì  â†’ ìë™ ì •ë¦¬ â†’ í†µê³„ ë³´ì¡´

### Payment & Billing Domain
1. **í¬ë ˆë”§ êµ¬ë§¤ í”Œë¡œìš°**: íŒ¨í‚¤ì§€ ì„ íƒ â†’ ê²°ì œ ì²˜ë¦¬ â†’ í¬ë ˆë”§ ì ë¦½ â†’ ê±°ë˜ ê¸°ë¡
2. **êµ¬ë… ê´€ë¦¬**: í”Œëœ ì„ íƒ â†’ ê²°ì œ ì„¤ì • â†’ ìë™ ê°±ì‹  â†’ ì²­êµ¬ì„œ ë°œí–‰
3. **ì‚¬ìš©ëŸ‰ ì¶”ì **: ì„œë¹„ìŠ¤ ì‚¬ìš© â†’ í¬ë ˆë”§ ì°¨ê° â†’ ë¡œê·¸ ê¸°ë¡ â†’ í†µê³„ ì§‘ê³„
4. **í™˜ë¶ˆ ì²˜ë¦¬**: ìš”ì²­ ê²€ì¦ â†’ ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤ â†’ í¬ë ˆë”§/ê¸ˆì•¡ í™˜ë¶ˆ â†’ ê¸°ë¡ ì—…ë°ì´íŠ¸

---

## ğŸ” ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

- ê³µìœ  ë§í¬ ì•”í˜¸í™”
- ì ‘ê·¼ ê¶Œí•œ ê²€ì¦
- ê²°ì œ ì •ë³´ ì•”í˜¸í™” (PCI DSS ì¤€ìˆ˜)
- ê±°ë˜ ë¬´ê²°ì„± ë³´ì¥
- Rate Limiting
- ì´ì¤‘ ì°¨ê° ë°©ì§€ (Idempotency)
- ê²°ì œ ê²Œì´íŠ¸ì›¨ì´ ë³´ì•ˆ ì—°ë™