# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Build Docker Image and Deploy to Elastic Beanstalk

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  push:
    branches: [ "main" ]

# ì›Œí¬í”Œë¡œìš°ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜
env:
  AWS_REGION: ap-northeast-2
  EB_APPLICATION_NAME: ${{ secrets.EB_APPLICATION_NAME }}
  EB_ENVIRONMENT_NAME: ${{ secrets.EB_ENVIRONMENT_NAME }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}
  S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2. JDK 17 ì„¤ì • (í”„ë¡œì íŠ¸ì— ë§ëŠ” ë²„ì „ìœ¼ë¡œ ìˆ˜ì •)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '17'
          cache: 'gradle'

      # 3. Gradle ë¹Œë“œ ê¶Œí•œ ë¶€ì—¬ ë° ì‹¤í–‰
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      - name: Run unit tests
        run: ./gradlew test --console=plain

      - name: Build with Gradle
        run: ./gradlew build -x test

      # 4. AWS ìê²© ì¦ëª… (OIDC ì—­í•  ìˆ˜ì„)
      # GitHub Secretsì— ì €ì¥ëœ AWS_ROLE_ARNì„ ì‚¬ìš©í•˜ì—¬ AWS ì—­í• ì„ ìˆ˜ì„
      - name: Configure AWS credentials
        id: login-aws
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      # 3. Amazon ECRì— ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECRì— í‘¸ì‹œ
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # 5. ë°°í¬ë¥¼ ìœ„í•œ Dockerrun.aws.json íŒŒì¼ ìƒì„±
      - name: Generate Dockerrun.aws.json
        run: |
          mkdir -p .ebextensions
          # í•„ìš”í•œ ì„¤ì • íŒŒì¼ì´ ìˆë‹¤ë©´ .ebextensions í´ë”ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          # ì˜ˆ: cp .ebextensions_example/logging.config .ebextensions/
          zip -r deploy.zip build/libs/*.jar .ebextensions .platform Procfile

      - name: Sync EB application environment
        run: |
          aws elasticbeanstalk update-environment \
            --application-name "${{ env.EB_APPLICATION_NAME }}" \
            --environment-name "${{ env.EB_ENVIRONMENT_NAME }}" \
            --option-settings Namespace=aws:elasticbeanstalk:application:environment,OptionName=GCP_SERVICE_ACCOUNT_JSON,Value="${GCP_SERVICE_ACCOUNT_JSON}"

      # 7. S3ì— ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
      - name: Upload package to S3
        run: |
          aws s3 cp deploy.zip s3://${S3_BUCKET_NAME}/deploy-${{ github.sha }}.zip

      # 8. Elastic Beanstalk ì• í”Œë¦¬ì¼€ì´ì…˜ ë²„ì „ ìƒì„±
      
      - name: Create new Elastic Beanstalk version
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name "${{ env.EB_APPLICATION_NAME }}" \
            --version-label "ver-${{ github.sha }}" \
            --source-bundle S3Bucket="${S3_BUCKET_NAME}",S3Key="deploy-${{ github.sha }}.zip" \
            --description "Commit SHA is ${{ github.sha }}"

      # 9. í™˜ê²½ì´ Ready ìƒíƒœì¸ì§€ í™•ì¸
      - name: Wait for environment to be ready
        run: |
          echo "Checking environment status..."
          for i in {1..30}; do
            STATUS=$(aws elasticbeanstalk describe-environments \
              --application-name "${{ env.EB_APPLICATION_NAME }}" \
              --environment-names "${{ env.EB_ENVIRONMENT_NAME }}" \
              --query "Environments[0].Status" \
              --output text)

            echo "Current status: $STATUS"

            if [ "$STATUS" = "Ready" ]; then
              echo "Environment is ready!"
              break
            fi

            if [ "$STATUS" = "Terminated" ] || [ "$STATUS" = "Terminating" ]; then
              echo "ERROR: Environment is terminated or terminating"
              exit 1
            fi

            echo "Waiting for environment to be ready... (attempt $i/30)"
            sleep 20
          done

      # 10. ìƒˆ ë²„ì „ì„ Elastic Beanstalk í™˜ê²½ì— ë°°í¬
      - name: Deploy new version to Elastic Beanstalk
        run: |
          aws elasticbeanstalk update-environment \
            --application-name "${{ env.EB_APPLICATION_NAME }}" \
            --environment-name "${{ env.EB_ENVIRONMENT_NAME }}" \
            --version-label "ver-${{ github.sha }}"

      # 11. ë°°í¬ URL ì¶œë ¥
      - name: Get deployment URL
        run: |
          echo "ğŸš€ Deployment complete!"
          URL=$(aws elasticbeanstalk describe-environments \
            --application-name "${{ env.EB_APPLICATION_NAME }}" \
            --environment-names "${{ env.EB_ENVIRONMENT_NAME }}" \
            --query "Environments[0].EndpointURL" \
            --output text)
          echo "ğŸ“ Application URL: http://$URL"
          echo "âœ… You can access your application at: http://$URL"

